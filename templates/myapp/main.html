<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GeoDa.app</title>
<style>
canvas {
  stroke: #000;
}
path {
  fill: green;
  stroke: #333;
  //stroke-linejoin: round;
}
.remove_map {
  width: 20px;
  height: 20px;
  float: left;
  margin-top: 20px;
  background-image: url("{{url_prefix}}/media/img/uncheckmark.gif");
  background-repeat:no-repeat;
}
.download_map {
  width: 20px;
  height: 20px;
  float: right;
  margin-top: 20px;
  background-image: url("{{url_prefix}}/media/img/download.png");
  background-repeat:no-repeat;
}
.map_div {
  width: 780;
  height: 360px;
  fill: none;
  margin: 0 auto;
}
.selected {
  fill: yellow;
}
.unselected {
  fill: green;
}

div {
  display: block;
}
#header {
  height: 80px;
  margin-bottom: 20px;
  padding-top: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}
#header .container {
  width: 90%;
  height: 90px;
  margin: 0 auto;
  text-align: left;
}
#header .logo {
  width: 480px;
}
body {
  text-align: center;
  font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
  font-size: 62.5%;
}
#dragdrop_div {
  width: 60%;
  padding: 10px;
}

#drop_zone {
  border: 2px dashed #bbb;
  border-radius: 5px;
  padding: 25px;
  text-align: center;
  font: 20pt bold 'Vollkorn';
  color: #bbb;
}

#dropbox_div {
  width: 250px; 
  height: 80px;
  margin-top: 10px;
  padding-top: 30px;
  vertical-align: middle;
  border-right:2px solid #ccc;
  float: left;
}
#progress_bar {
  margin: 10px 0;
  padding: 3px;
  border: 1px solid #000;
  font-size: 14px;
  clear: both;
  opacity: 0;
  -moz-transition: opacity 1s linear;
  -o-transition: opacity 1s linear;
  -webkit-transition: opacity 1s linear;
}
#progress_bar.loading {
  opacity: 1.0;
}
#progress_bar .percent {
  background-color: #99ccff;
  height: auto;
  width: 0;
}
.check_file {
  background-image: url("{{url_prefix}}/media/img/checkmark.png");
  background-repeat:no-repeat;
  background-position:right; 
}
.uncheck_file {
  color: red;
  font-weight: bold;
}
#preview {
  width: 90%;
  height: 500px;
  margin-top: 20px;
  padding-top: 20px;
  margin:0 auto;
  text-align: center;
}
#toolbar {
  width: 90%;
  height: 100px;
  margin-top: 20px;
  margin:0 auto;
}
.toolbar_tbl {
  margin-top: 20px; 
  border: none; 
  overflow: hidden;
}
.block_button {
  border: 1px solid #bbb;
  border-radius: 5px;
  padding: 25px;
  opacity: 0.2;
  background: #ccc;
  background-repeat: no-repeat;
  background-position: center;
}
#btnOpenData {background-image: url({{url_prefix}}/media/img/add-file.png);}
#btnAddLayer {background-image: url({{url_prefix}}/media/img/addLayer.png);}
#btnSave {background-image: url({{url_prefix}}/media/img/save.png);}
#btnShowTable {background-image: url({{url_prefix}}/media/img/table.png);}
#btnCreateW {background-image: url({{url_prefix}}/media/img/newW.png);}
#btnWHistogram{background-image: url({{url_prefix}}/media/img/wHist.png);}
#btnKDE{background-image: url({{url_prefix}}/media/img/kde.png);}
#btnNewMap{background-image: url({{url_prefix}}/media/img/nmap.png);}
#btnScatterPlot{background-image: url({{url_prefix}}/media/img/scatter.png);}
#btnHist{background-image: url({{url_prefix}}/media/img/hist.png);}
#btnPCP{background-image: url({{url_prefix}}/media/img/pcp.png);}
#btnLISA{background-image: url({{url_prefix}}/media/img/lisa.png);}
#btnSpreg{background-image: url({{url_prefix}}/media/img/spreg.png);}
#btnAbout {background-image: url({{url_prefix}}/media/img/about.png);}
</style>

<link rel="stylesheet" href="{{url_prefix}}/media/css/csslider.css" />
<script src="{{url_prefix}}/media/js/jquery.min.js"></script>
<script src="{{url_prefix}}/media/js/d3.v3.min.js"></script>
<script src="{{url_prefix}}/media/js/inflate.js"></script>
<script src="{{url_prefix}}/media/js/zip/zip.js"></script>
<script src="{{url_prefix}}/media/stream.js"></script>
<script src="{{url_prefix}}/media/shapefile.js"></script>
<script src="{{url_prefix}}/media/dbf.js"></script>
<script src="{{url_prefix}}/media/js/indexeddb.js"></script>
<script src="{{url_prefix}}/media/js/utils.js"></script>
<script src="{{url_prefix}}/media/js/jsonmap.js"></script>
<script type="text/javascript" src="{{url_prefix}}/media/js/dropins.js" id="dropboxjs" data-app-key="50dk6qp6nc2fcxs"></script>

<link rel="stylesheet" href="{{url_prefix}}/media/css/{{theme_jquery}}/jquery-ui-1.10.4.custom.min.css">
<script src="{{url_prefix}}/media/js/jquery-ui-1.10.4.custom.min.js"></script>
<script src="{{url_prefix}}/media/js/list.min.js"></script>

</head>

<body>
<style>
.bubble {
  z-index: 10000;
  position: absolute;
  background-color: orange;
  opacity: 0.8;
  margin: 0;
  padding:10px;
  text-align:center;
  width:180px;
  -moz-border-radius:10px;
  -webkit-border-radius:10px;
  -webkit-box-shadow: 0px 0 3px rgba(0,0,0,0.25);
  -moz-box-shadow: 0px 0 3px rgba(0,0,0,0.25);
  box-shadow: 0px 0 3px rgba(0,0,0,0.25); 
}
</style>
<div id="divPop" class="bubble">This is Popup Div.</div>

<script type="text/javascript">
// global variables
var highlighted = {};
var html_load_img = "<img src={{url_prefix}}/media/img/loading_small.gif>",
    html_check_img = "<img src={{url_prefix}}/media/img/checkmark.png>",
    html_uncheck_img = "<img src={{url_prefix}}/media/img/uncheckmark.png>";

// fill forms and controls after uploading data files
function refillCombobox(kv) { }
function sortKeys() { }
function toggleTubar(isPts) { }
function loadSpregP() {
  $.get("../get_spreg_p/", {},function() {})
  .done(function(data) {
    if ( data["success"] != 1 ) {
      console.log("get spreg preference failed.");
    } else {
      var txt_items = ['gmm_epsilon', 'gmm_max_iter', 'instruments_w_lags', 'other_missingValue', 'ml_epsilon'];
      var sel_items = ['gmm_inv_method', 'ml_method'];
      for ( var k in data ) {
        var v = data[k];
        if ( $.inArray(k, txt_items) >= 0 ) {
          $('input[name='+k+']').val(v[0]);
        } else if ( $.inArray(k, sel_items) >=0 ) {
          $('select[name='+k+']').val(v[0]);
        } else if ( k.match("^sig2n_k") ) {
          v = v ? 1 : 0;
          $('input[name='+k+'][value='+v+']').prop('checked', true);
        } else { 
          $('input[name='+k+']').prop('checked', v);
        }
      }
    }
  });
}
function loadWnames() {
  var layer_uuid = localStorage.getItem('current_layer');
  if (  layer_uuid != undefined ){
    // get weights name:uuid
    $.get("../get_weights_names/", {"layer_uuid": layer_uuid},function() {
    }).done(function(data) {
      if ( "success" in data ) {
        console.log("get weights names failed.");
        return;
      }
      var w_names = [];
      for ( var key in data ) {
        w_names.push(key); 
      }
      w_names.sort();
      w_combobox= ['#sel-model-w-files', '#sel-kernel-w-files', '#sel-w-files'];
      $.each( w_combobox, function(i, w_cmb ) {
        $(w_cmb).find('option').remove().end();
        $.each(w_names, function(j, w_name) {
          wtype = data[w_name]["type"];
          if ( (wtype <= 1 && w_cmb == w_combobox[0]) 
                || (wtype == 2 && w_cmb == w_combobox[1]) 
                || w_cmb == w_combobox[2] ) {
            wuuid = data[w_name]["uuid"];
            $(w_cmb).append($('<option>', {value: wuuid}).text(w_name));
          }
        });
      });
      $('#sel-w-files').prop("selectedIndex", -1);
    });
  }
}
function loadMinPairDist() {
  var layer_uuid = localStorage.getItem('current_layer');
  if (  layer_uuid != undefined ) {
    $.get("../get_minmaxdist/", {"layer_uuid": layer_uuid})
    .done( function(data) {
      if ( data["success"] != 0 ) {
        $('#dist-slider').slider('option', {min: data['min'], max: data['max']});
        $('#txt-dist-thr').val(data['min']);
      }
    });
  }
}
function loadFieldNames( onSuccess ) {
  var layer_uuid = localStorage.getItem('current_layer');
  if (  layer_uuid != undefined ){
    $.get("../get_fields/", {"layer_uuid": layer_uuid})
    .done(function(data){
      if ( data["success"] == 0 ) {
        console.log("ERROR: get_fields()", layer_uuid); 
        return;
      }
      var fields = data; 
      var field_names = [];
      for ( var key in fields ){
        field_names.push(key); 
      }
      field_names.sort();
      // in weights creation dialog
      $('#sel-w-id').find('option').remove().end();
      $('#sel-w-id').append($('<option>', {value: ""}).text(""));
      $('#sel-w-id').append($('<option>', {value: "0"}).text("[Add Unique ID]"));
      $.each(field_names, function(i, field_name) {
        if ( fields[field_name] != "String" ) {
          $('#sel-w-id').append($('<option>', {value: field_name}).text(field_name));
        }
      });
      // in regression dialog
      if ( !$('#y_box').find(".placeholder")) 
        $('#y_box').find('li').remove().end();
      if ( !$('#x_box').find(".placeholder")) 
        $('#x_box').find('li').remove().end();
      if ( !$('#ye_box').find(".placeholder")) 
        $('#ye_box').find('li').remove().end();
      if ( !$('#inst_box').find(".placeholder")) 
        $('#inst_box').find('li').remove().end();
      if ( !$('#r_box').find(".placeholder")) 
        $('#r_box').find('li').remove().end();
      $('#ul-x-variables').find('li').remove().end();
      $.each(field_names, function(i, field_name) {
        if ( fields[field_name] != "String" ) {
          var item = $('#ul-x-variables').append('<li><p class="name">'+field_name+'</p></li>');
        }
      });
      $( "#vars ul li" ).draggable({ helper: "clone" });
      new List('vars', {valueNames:['name']});
      
      if (onSuccess) {
        onSuccess();
      }
    });
  }
}
function loadModelNames() {
  var layer_uuid = localStorage.getItem('current_layer');
  if (  layer_uuid != undefined ) {
    $.get("../get_spreg_models/", {"layer_uuid": layer_uuid})
    .done(function(data){
      console.log(data);
      if ( data["success"] == 0 ) {
        console.log("ERROR: get_spreg_models()", layer_uuid); 
        return;
      }
      $('#open_spreg_model').find('option').remove().end();
      $.each(data, function(i, model) {
        $('#open_spreg_model').append($('<option>',{value: model}).text(model));
      });
    });
  }
}
function InitRemoveButtons() {
  $('.map_div').mouseover(function(){
    $(this).prev().show();
    $(this).prev().prev().show();
  });
  $('.map_div').mouseleave(function(){
    $(this).prev().hide();
    $(this).prev().prev().hide();
  });
  $('.download_map').hide().mouseover(function(){ $(this).show(); })
  .mouseleave(function(){ $(this).hide(); })
  .click( function(){
    var that = $(this);
    var layer_uuid = that.attr("id");
    $.download("../download_map/", "layer_uuid="+layer_uuid, "get");
  });
  $('.remove_map').hide().mouseover(function(){ $(this).show(); })
  .mouseleave(function(){ $(this).hide(); })
  .click( function(){
    var that = $(this);
    $('<div></div>').appendTo('body')
      .html('<br/><div>Are you sure you want to delete this map?</div>')
      .dialog({
        modal: true,
        title: "Confirmation required",
        buttons: {
          Yes: function() {
            var layer_uuid = that.attr("id");
            $.get("../remove_map/", {"layer_uuid": layer_uuid})
            .done( function(data) {
              if (data["success"] == 1) {
                var idx = $("#mapslider ul li").index(that.parent().parent())+1;
                var next_idx = idx < mapCounter ? idx + 1 : idx - 1;
                SelectMap($('label[for=slides_'+next_idx).get(0));
                if ( idx >= mapCounter ) {
                  $('#map-arr label[for=slides_' + next_idx +']').click();
                }
                setTimeout( function() {
                  that.closest("li").remove();
                  $("label[for=slides_" + mapCounter).remove();
                  mapCounter--;
                  if (mapCounter == 0) {
                    localStorage.setItem('current_layer', undefined);
                    $('#btnCreateW, #btnSpreg, #btnNewMap').css("opacity",0.2);
                  }
                }, 100);
              }
            });
            $(this).dialog("close");
          },
          No: function() {
            $(this).dialog("close");
          }
        },
        close: function( evt, ui) { $(this).remove(); }
      });
  });
}
function fillForms(is_new) {
  if ( localStorage["current_layer"] ) {
    $('#btnCreateW, #btnSpreg, #btnNewMap').css("opacity",1);
  }
  loadWnames();
  setTimeout(loadFieldNames, 100);
  setTimeout(loadSpregP, 100);
  setTimeout(loadModelNames, 100);
  if ( is_new ) {
    setTimeout(loadMinPairDist, 3000);
  } else {
    loadMinPairDist();
  }
}
// map function
var data; // global for testing

function SelectMap(obj) {
  var slider_id = $(obj).attr("for");
  if ( slider_id ) {
    var idx = slider_id.split("_")[1] - 1,
        layer_id = $($('#mapslider ul li').get(idx)).children().children()
                  .first().attr("id");
    localStorage.setItem("current_layer", layer_id);
    fillForms();
  }
}

{% if geodata %}
var mapCounter = {{ n }};
{% else %}
var mapCounter = 0;
{% endif %}

function CreateMapContainer(jsonFilePath) {
  mapCounter++;
  var containerID = 'map' + mapCounter;
  $('#mapslider ul').append("<li><center>" + jsonFilePath + "<div id="+containerID+" class='map_div'></div></center></li>"); 
  $('#mapnav').append("<label for=slides_"+mapCounter+"></label>");
  $('.arrows').append("<label for=slides_"+mapCounter+"></label>");
  $('#mapslider').removeClass('csslider').addClass('csslider');
  $('#map-arr').removeClass('arrows').addClass('arrows');
  $('#map-nav').removeClass('navigation').addClass('navigation');
  localStorage[containerID] = jsonFilePath;
  $('#slides_'+mapCounter).prop("checked", true);
  return containerID;
}

function SaveMapThumbnail(layer_uuid, containerID) {
  var canvas = $('#' + containerID + ' canvas');
  if ( layer_uuid != undefined && canvas[0] != undefined &&
       layer_uuid == localStorage.getItem('current_layer')) {
    if (canvas.attr("id") == undefined ) {
      console.log("upload thumbnail");
      canvas.attr("id", layer_uuid);
      $("<div class='remove_map' id='"+layer_uuid+"'></div>").insertBefore(canvas.parent());
      $("<div class='download_map' id='"+layer_uuid+"'></div>").insertBefore(canvas.parent());
      InitRemoveButtons();
      var dataURL = canvas[0].toDataURL();
      $.ajax({
        type: "POST",
        url: "../upload_canvas/",
        data: { 
          imageData: dataURL,
          layer_uuid: layer_uuid,
          csrfmiddlewaretoken: '{{ csrf_token }}',
        }
      }).done(function(data) {
        console.log('save canvas:', data); 
      });
    }
  } else {
    setTimeout( function(){ SaveMapThumbnail(layer_uuid, containerID); }, 500); 
  }
}

var w = 600;
var h = 400;
function ShowJsonMap(containerID, jsonFilePath, content, onSuccess) {
  //Load GeoJSON data
  var createJsonMap = function(json) {
    console.log("draw map", jsonFilePath);
    data = json;
    var canvas = $("<canvas width="+w+" height="+h+"></canvas>").appendTo($('#' + containerID));
    var minX = Number.POSITIVE_INFINITY,
      maxX = Number.NEGATIVE_INFINITY,
      minY = Number.POSITIVE_INFINITY,
      maxY = Number.NEGATIVE_INFINITY;
    var shpType = json.features[0].geometry.type;
    if ( shpType == "Polygon" || shpType == "MultiPolygon" ) {
      json.features.forEach(function(feat,i) {
        feat.geometry.coordinates.forEach(function(coords,j) {
          coords.forEach( function( xy,k ) {
            x = xy[0], y = xy[1];
            if (x > maxX) {maxX = x;}
            if (x < minX) {minX = x;}
            if (y > maxY) {maxY = y;}
            if (y < minY) {minY = y;}
          });
        });
      });
    } else if ( shpType == "Point" || shpType == "MultiPoint" ){
      json.features.forEach(function(feat,i) {
        var pt = feat.geometry.coordinates,
            x = pt[0],
            y = pt[1];
            if (x > maxX) {maxX = x;}
            if (x < minX) {minX = x;}
            if (y > maxY) {maxY = y;}
            if (y < minY) {minY = y;}
      });
    }
    var xyratio = (maxX-minX)/(maxY-minY),
      offsetW = 0.0,
      offsetH = 0.0;
    if (w/h > xyratio) { // too wide
      offsetW = (w - h*xyratio)/2.0;
    } else if (w/h < xyratio) { // too tall
      offsetH = (h - w/xyratio)/2.0;
    }
    var scaleX = d3.scale.linear()
      .domain([minX,maxX])
      .range([0, w-offsetW*2]),
    scaleY = d3.scale.linear()
      .domain([minY, maxY])
      .range([h-offsetH*2,0]);
    function matrix(a, b, c, d, tx, ty) {
      return d3.geo.transform({
        point: function(x, y) { 
          this.stream.point(scaleX(x)+offsetW, scaleY(y)+offsetH); 
        }
      });
    }
    var context = canvas[0].getContext("2d");
    context.lineWidth = 1
    context.strokeStyle = "#cccccc";
    context.fillStyle = "#ffffff";
    context.imageSmoothingEnabled= false;
    if ( shpType == "Polygon" ) { 
      json.features.forEach( function(feat,i) {
        feat.geometry.coordinates.forEach(function(coords,j) {
          context.beginPath();
          coords.forEach( function(xy,k) {
            var x = xy[0], y = xy[1];
            x = scaleX(x)+offsetW;
            y = scaleY(y)+offsetH;
            if (k === 0) {
              context.moveTo(x,y);
            } else {
              context.lineTo(x,y);
            }
          });
          context.closePath();
          context.stroke();
        });
      });
    } else if ( shpType == "Point" ) {
      json.features.forEach( function(feat,i) {
        var pt = feat.geometry.coordinates,
            x = pt[0],
            y = pt[1];
        x = scaleX(x)+offsetW;
        y = scaleY(y)+offsetH;
        context.fillRect(x,y,2,2);
      });
    }
    //context.fill();
  }; // end createJsonMap
  if (content!=undefined) {
    createJsonMap(content);
  } else {
    console.log("load from raw data");
    var suffix = getSuffix(jsonFilePath);
    if (suffix === "json" || suffix === "geojson") {
      d3.json(jsonFilePath, createJsonMap);
    } else if (suffix === "zip") {
      FetchZipResource(jsonFilePath, function(data){
        jsonContent = JSON.parse(data);
        createJsonMap(jsonContent);
      });
    }
  }
} 

var socket;
var db;

function ShowMsgBox(title, content) {
  $("#msg-title").text(title);
  $("#msg-content").text(content);
  $('#dlg-msg').dialog('open');
}

// Init 
$(document).ready(function() {
  // init some divs
  $('#btnOpenData').popupDiv('#divPop','Start by click this button to load your data.');
  $('#img-id-chk').hide();
  $('#img-id-spin').hide();
  $('#img-id-nochk').hide();

  $( "#dlg-msg" ).dialog({
    dialogClass: "dialogWithDropShadow",
    width: 400,
    height: 200,
    autoOpen: false,
    modal: true,
    buttons: {
      OK: function() {$( this ).dialog( "close" );},
    }
  });
 
  InitRemoveButtons();
  $("#dlg-run").dialog({
    dialogClass: "dlg-run",
    width: 460,
    minHeight:100,
    autoOpen: false,
    modal: true,
    resizable: false,
  });
  // init current working layer if exists  
  {% if n == 0 %} 
  localStorage.removeItem('current_layer');
  {% else %}
  localStorage.setItem('current_layer', '{{geodata0.uuid}}');
  {% endif %}


  // Dropbox Plugin
  var dropboxOptions = {
    success: function(files) {
      if ( files.length > 0 ) { 
        var ready = false;
        var fileLink = files[0].link;
        var suffix = getSuffix(fileLink);
        var params = {csrfmiddlewaretoken: '{{ csrf_token }}'};
        var containerID = CreateMapContainer(fileLink);
        if ( suffix === 'geojson' || suffix === 'json') {
          ShowJsonMap(containerID, fileLink);
          params['json'] = fileLink;
          ready = true;
        } else if ( $.inArray( suffix, ['shp', 'dbf','shx','prj']) >= 0) {
          var shp, shx, dbf,
              fname = getFileNameNoExt( fileLink );
          $.each(files, function(i, file) {
            var f = file.link;
            if ( getSuffix(f)=='shp' && fname==getFileNameNoExt(f) ) {
              shp = f;
            } else if ( getSuffix(f)=='dbf' && fname==getFileNameNoExt(f) ) {
              dbf = f;
            } else if ( getSuffix(f)=='shx' && fname==getFileNameNoExt(f) ) {
              shx = f;
            }
          });
          if (shp && shx && dbf) {
            new Shapefile(shp, function(content) {
              ShowJsonMap(containerID, shp, content.geojson);
            });
            params['shp'] = shp;
            params['shx'] = shx;
            params['dbf'] = dbf;
            ready = true;
          } else {
            ShowMsgBox("Error","Please select *.shp, *.dbf, and *.shx files at the same time.");
          }
        }
        if ( ready ) {
          $('#dlg-run').dialog("open").html('<img src="{{url_prefix}}/media/img/loading.gif"/><br/>Loading ...');
          $('#dlg-run').siblings('.ui-dialog-titlebar').hide();
          //$('#dlg-run').css("background-color","rgb(255,255,255, 0.9)");
          $.get("../upload/", params)
          .done( function(data) {
            $('#dlg-run').dialog("close");
            if ( data['layer_uuid'] != undefined) {
              var layer_uuid = data["layer_uuid"];
              localStorage['current_layer']= layer_uuid;
              fillForms(true);
              // get canvas
              SaveMapThumbnail(layer_uuid, containerID);
            }
          });
        }
      }
    },
    cancel: function() {
      $('#progressCont').hide();
    },
    linkType: "direct", // or "preview"
    multiselect: true, // or true
    extensions: ['.json', '.geojson', '.zip', '.shp','.shx','.dbf','.prj'],
  };
  var button = Dropbox.createChooseButton(dropboxOptions);
  $("#dropbox_div").append(button);
  $('#dropbox_div').click(function() {});

  // DragDrop Plugin
  var reader;
  var progress = document.querySelector('.percent');

  function updateProgress(evt) {
    // evt is an ProgressEvent.
    if (evt.lengthComputable) {
      var percentLoaded = Math.round((evt.loaded / evt.total) * 100);
      // Increase the progress bar length.
      if (percentLoaded < 100) {
        progress.style.width = percentLoaded + '%';
        progress.textContent = percentLoaded + '%';
      }
    }
  }
  function checkShpFileComplete(files) {
  }
  function handleFileSelect(evt) {
    $("#"+evt.target.id).css("color", "#bbb");
    evt.stopPropagation();
    evt.preventDefault();
  
    // Reset progress indicator on new file selection.
    progress.style.width = '0%';
    progress.textContent = '0%';
  
    var formData = new FormData(),
        files = evt.dataTransfer.files, // FileList object.
        bJson = 0,
        bShp = [0, 0, 0],
        shpFileName = "",
        shpFile;
    $.each(files, function(i, f) {
      var name = f.name,
          suffix = getSuffix(name);
      if (suffix === 'geojson' || suffix === 'json') {
        bJson = 1;
        shpFileName = name;
        shpFile = f;
      } else if (suffix === "shp") {
        bShp[0] = 1;
        shpFileName = name;
        shpFile = f;
      } else if (suffix === "shx") {
        bShp[1] = 1;
      } else if (suffix === "dbf") {
        bShp[2] = 1;
      }
    });
    
    // check files
    if (!bJson && !bShp[0] && !bShp[1] && !bShp[2]) {
      ShowMsgBox("Error", "Please drag&drop either one json/geojson file, or three files (*.shp, *.dbf and *.shx) ")
      return false;
    } else if (!bJson && (!bShp[0] || !bShp[1] || !bShp[2])) {
      ShowMsgBox("Error", "Please drag&drop three files (*.shp, *.dbf and *.shx)  at the same time. (Tips: use ctrl (windows) or command (mac) to select multiple files.)")
      return false;
    } 
    $.each(files, function(i, f) {
      if ($.inArray(getSuffix(f.name), ['json','geojson','shp','shx','dbf'] ) >=0) {
        formData.append('docfile', f, f.name);
      }
    });
    var fileurl = "local://" + shpFileName;
    var containerID = CreateMapContainer(fileurl);
    if ( bJson) {
      var reader = new FileReader();
      //reader.onprogress = updateProgress;
      reader.onabort = function(e) { console.log('File read cancelled');}; 
      reader.onloadstart = function(e) { };
      reader.onloadend =  function(evt) {
        if (evt.target.readyState == FileReader.DONE) {
          var data = evt.target.result;
          ShowJsonMap(containerID, fileurl, JSON.parse(data));
        }
      };
      reader.readAsText(shpFile);
      
    } else if (bShp[0] && bShp[1] && bShp[2]) {
      var opts = { shp: shpFile };
      new Shapefile(opts, function(content){
        var json = content.geojson;
        ShowJsonMap(containerID, fileurl, json);
      }); 
    }
    
    // upload files to server
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '../upload/');
    xhr.onload = function() {
      try{
        data = JSON.parse(this.responseText);
        if ( data['layer_uuid'] != undefined) {
          var layer_uuid = data["layer_uuid"];
          localStorage['current_layer']= layer_uuid;
          fillForms(true);
          // get canvas
          console.log("save map thumbnail");
          SaveMapThumbnail(layer_uuid, containerID);
        }
      } catch(e){console.log(e);}
      // Ensure that the progress bar displays 100% at the end.
      progress.style.width = '100%';
      progress.textContent = '100%';
      setTimeout("document.getElementById('progress_bar').className='';", 2000);
    }; 
    xhr.upload.onprogress = updateProgress;
    xhr.send(formData);
    document.getElementById('progress_bar').className = 'loading';
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    $("#"+evt.target.id).css("color", "black");
  }

  function handleDragOut(evt) {
    $("#"+evt.target.id).css("color", "#bbb");
  }

  // Setup the dnd listeners.
  var dropZone = document.getElementById('drop_zone');
  dropZone.addEventListener('dragover', handleDragOver, false);
  dropZone.addEventListener('dragleave', handleDragOut, false);
  dropZone.addEventListener('drop', handleFileSelect, false);

  // Buttons 
  $('#btnOpenData').css("opacity",1);
  if ( localStorage["current_layer"] ) {
    $('#btnCreateW, #btnSpreg, #btnNewMap').css("opacity",1);
  }
  $('#file_div').hide();
  $('#btnOpenData').click(function(){
    $('#file_div').slideToggle("slow");  
  });
  $('#btnShowMap').click(function(){
    $('[name="slides"]').each(function(i, obj){
      if ( obj.checked === true) {
        var map_id = "map"+ obj.id.slice(-1);
        var map_url = localStorage[map_id];
        if (map_url) {
          window.open("template_json_map.html?json="+map_url,"");
        }
        return;
      }
    });
  });
  $('#btnCreateW').click(function(){
    // pop-up weights creation dialog
    if (localStorage.getItem('current_layer') != undefined) {
      $('#dialog-weights').dialog('open');
    }
  });
  $('#btnSpreg').click(function(){
    // pop-up weights creation dialog
    if (localStorage.getItem('current_layer') != undefined) {
      $('#dialog-regression').dialog('open');
    }
  });
  $('#btnNewMap').click(function(){
    if (localStorage.getItem('current_layer') != undefined) {
      window.open("../new_map/?layer_uuid="+layer_uuid,"_blank");
    }
  });
  //test 
  fillForms();
});
</script>

<script>
$('#divPop').hide();
jQuery.fn.popupDiv = function (divToPop, text) {
  var pos=$(this).offset();
  var h=$(this).height();
  var w=$(this).width();
  if (w == 0) w = 40;
  if ( text != undefined ) {
    $(divToPop).html(text);
  }
  $(divToPop).css({ left: pos.left + w , top: pos.top - h });
  $(divToPop).show(function() {
    setTimeout(function(){
      $(divToPop).fadeOut('slow');
    }, 2000);
  });
};
</script>

<div id="header"> 
  <div class="container">
    <img src="{{url_prefix}}/media/img/cloud.png"/>
    <font style="color: #666;" size=16 face="Century Gothic">{</font>
    <font style="color: #666; font-size: 30px">'Spatial Data Analysis':</font>
    <font style="color: #666; font-size: 30px" face="Copperplate">WEB</font>
    </font><font style="color: #666;" size=16 face="Century Gothic">}</font>
  </div>
  <div style="float:right">
  welcome {{userid}}. <button id="btn_logout">logout</button>
  </div>
</div>
<script>
$('#btn_logout').click(function(){
  $.post("../logout/", {csrfmiddlewaretoken: '{{ csrf_token }}'})
  .done(function(data) {
    location.reload();
  });
});
</script>
<table width="100%">
  <tr><td width="45"></td>
  <td valign="top" width="30">
    <div id="toolbar">
      <div style="clear: left;"></div>
      <table class="toolbar_tbl" align="left" >
        <tr><td><div class="block_button" id="btnOpenData"></div></td></tr> 
        <tr><td><div class="block_button" id="btnCreateW"></div></td></tr> 
        <tr><td><div class="block_button" id="btnSpreg"></div></td></tr> 
        <tr><td height="10px"></td></tr>
          <!--
        <tr><td><div class="block_button" id="btnAbout"></div></td></tr>
          <td><div class="block_button" id="btnAddLayer"></div></td> 
          <td><div class="block_button" id="btnSave"></div></td> 
          <td><div class="block_button" id="btnShowTable"></div></td> 
          <td><div class="block_button" id="btnWHistogram"></div></td> 
          <td><div class="block_button" id="btnNewMap"></div></td> 
          <td><div class="block_button" id="btnKDE"></div></td> 
          <td><div class="block_button" id="btnScatterPlot"></div></td> 
          <td><div class="block_button" id="btnHist"></div></td> 
          <td><div class="block_button" id="btnPCP"></div></td> 
          <td><div class="block_button" id="btnLISA"></div></td> 
          -->
      </table>
    </div>
  </td>
  <td>
    <div id="file_div"> 
      <div id="main_div" style="width: 80%;margin: 0 auto;">
        <div id="file_choose_div" style="width: 100%; margin: 0 auto;">
          <div id="dropbox_div"></div>
          <div id="dragdrop_div" style="margin-left: 350px;">
            <div id="drop_zone">Drop files here
              <p style="font-size:12px;"><label id="lbl-drop-json">*.json</label>&nbsp;&nbsp;or &nbsp;&nbsp;
              <label  id="lbl-drop-shp">*.shp</label>&nbsp;<label id="lbl-drop-dbf">*.dbf</label>
              &nbsp;<label id="lbl-drop-shx">.shx</label>&nbsp;&nbsp;or &nbsp;&nbsp;
              <label>*.zip</label></p>
            </div>
            <div id="progress_bar"><div class="percent">0%</div></div>
          </div>
        </div>
      </div>
    </div>
    
    <div id="preview"> 
      <div id="mapslider" class="csslider" style="z-index:100">
        <input type="radio" name="slides" id="slides_1" checked />
        <input type="radio" name="slides" id="slides_2" />
        <input type="radio" name="slides" id="slides_3" />
        <input type="radio" name="slides" id="slides_4" />
        <input type="radio" name="slides" id="slides_5" />
        <input type="radio" name="slides" id="slides_6" />
        <input type="radio" name="slides" id="slides_7" />
        <input type="radio" name="slides" id="slides_8" />
        <input type="radio" name="slides" id="slides_9" />
        <input type="radio" name="slides" id="slides_10" />
        <ul>
        {% if geodata %}
          {% for i,layer in geodata.iteritems %}
          <li>
            <center> {{layer.origfilename}}
              <div class="remove_map" id="{{layer.uuid}}"></div>
              <div class="download_map" id="{{layer.uuid}}"></div>
              <div id="map{{i}}" class="map_div"><img id="{{layer.uuid}}" src="{{url_prefix}}{{layer.thumbnail}}"></div>
            </center>
          </li>
          {% endfor %}
        {% endif %}
        </ul>
        <div id="map-arr" class="arrows">
        {% if geodata %}
          {% for i in nn %}
          <label onclick="SelectMap(this)" for="slides_{{i}}"></label>
          {% endfor %}
        {% endif %}
        </div>
        <div id="map-nav" class="navigation">
          <div id="mapnav">
          {% if geodata %}
            {% for i in nn %}
            <label for="slides_{{i}}"></label>
            {% endfor %}
          {% endif %}
          </div>
        </div>
      </div>
    </div>
  </td></tr>
</table>

<style>
  .ui-widget-overlay { background: #eee repeat-x; opacity: .8;}
  table { border-spacing: 0;}
  th { text-align: left; padding: 10px 0 10px 0; }
  h1 { padding: .2em; margin: 0; font-size: 13px;}
  ol li:hover {background-color: #eee;}
  .list { margin:0; padding:0px 0 0; }
  .list li {
    display:block; background-color: #ddd; padding:1px; box-shadow: inset 0 1px 0 #fff;
    height: 20px;  cursor: pointer; cursor: hand; vertical-align: bottom;
  }
  .list li p { margin: 0px; padding: 4px 0px 0px 10px; vertical-align: bottom; }
  .list li:nth-child(odd) {background: #fff;}
  .list li:hover { background-color: orange; }

  .dialogWithDropShadow{
    -webkit-box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.5);  
    -moz-box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.5); 
  }
  #weights { width: 600px; height: 90px; margin-right: 2em; display:block;}
  #weights select {width: 90%;}
  #w_catalog_model {width: 48%; float: left;}
  #w_catalog_kernel {width: 50%; float: right;}
  #model_spec { width: 600px; margin-right: 2em; height:370px; display:block;}
  #y_catalog {width: 48%; float: left;}
  #x_catalog {width: 50%; float: right;}
  #x_catalog.x_box {height: 200px;}
  #var_list { width: 200px; }
  /* style the list to maximize the droppable hitarea */
  .drop_box ol { list-style-type: circle; height: 100px; margin: 0; padding: 1em 0 1em 2em; }
  #x_box ol {height: 215px;}

  #estimation { width: 600px; margin-right: 2em; height:170px; display:block;}
  .est_tab { border: 1px #bbb solid; border-radius:5px; width: 32%; height: 120px; float: left; margin: 15px 1px 0 0; padding-left: 5px;}
  .est_tab p { margin: -5px 0 5px 5px; background-color: white; width: 100px; text-align:center; font-weight: bold;}
  .est_tab input { margin-bottom: 8px;}
</style>
<div id="dialog-regression" title="Spatial Regression Dialog"> 
  <p style="text-align: left">
  <button id="btn_open_model">Open Model</button>
  <button id="btn_save_model">Save Model</button>
  <button id="btn_reset_model">Reset Model</button>
  <button id="btn_preference">Preference</button>
  <button id="btn_run">Run</button>
  <button id="btn_result">Show Result</button>
  </p>
  <table>
    <tr><td></td></tr>
    <tr>
      <td valign="top">
        <div id="model_spec">
          <h1 class="ui-widget-header">Model Specifications</h1>
          <p>Drag and drop variables from the Variables Panel.<br>Double click variable to remove it.</p>
          <div id="y_catalog">
            <h2><a href="#">Y (Required) </a></h2>
            <div class="drop_box" id="y_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
            <h2><a href="#">YE </a></h2>
            <div class="drop_box" id="ye_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
            <h2><a href="#">Instruments</a></h2>
            <div class="drop_box" id="inst_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
            <h2><a href="#">R</a></h2>
            <div class="drop_box" id="r_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
            <!--
            <h2><a href="#">T</a></h2>
            <div class="drop_box" id="t_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
            -->
          </div>
          <div id="x_catalog">
            <h2><a href="#">X (Required) </a></h2>
            <div class="drop_box" id="x_box">
              <ol>
                <li class="placeholder">Add your items here</li>
              </ol>
            </div>
          </div>
        </div>
        <div id="estimation">
          <h1 class="ui-widget-header">Estimation</h1>
          <div class="est_tab">
            <p>Model Type</p>
            <input type="radio" name="model_type" value="0" checked>Standard<br>
            <input type="radio" name="model_type" value="1">Spatial Lag<br>
            <input type="radio" name="model_type" value="2">Spatial Error<br>
            <input type="radio" name="model_type" value="3">Spatial Lag+Error<br>
          </div>
          <div class="est_tab">
            <p>Method</p>
            <input id="ols" type="radio" name="method" value=0 checked>OLS<br>
            <input id="gmm" type="radio" name="method" value=1>GMM<br>
            <input id="ml" type="radio" name="method" value=2>ML<br>
          </div>
          <div class="est_tab">
            <p>Standard Errors</p>
            <input id="white" type="checkbox" name="stderror" value="white">White<br>
            <input id="hac" type="checkbox" name="stderror" value="hac">HAC<br>
            <input id="het" type="checkbox" name="stderror" value="kphet">KP HET<br>
          </div>
        </div>
        <div id="weights">
          <h1 class="ui-widget-header">Weights</h1>
          <table width=100%><tr><td>
          <button id="btn_create_w">Create Weights</button> 
          </td></tr><tr><td>
          <div id="w_catalog_model">
            <h2><a href="#">Model Weights (Optional) </a></h2>
            <div id="w_model_box">
              <select id="sel-model-w-files" multiple="multiple">
              </select>
            </div>
          </div>
          <div id="w_catalog_kernel">
            <h2><a href="#">Kernel Weights (Optional) </a></h2>
            <div id="w_kernel_box">
              <select id="sel-kernel-w-files" multiple="multiple">
              </select>
            </div>
          </div>
          </td></tr></table>
        </div>
      </td>
      <td valign="top">
        <div id="var_list">
          <h1 class="ui-widget-header">Variables</h1>
          <div class="ui-widget-content" id="vars">
            <input class="search" placeholder="Search" />
            <button class="sort" data-sort="name">
            Sort
            </button>
            <ul id="ul-x-variables" class="list">
              <li><p class="name">x1</p></li>
            </ul>
          </div>
        </div>

  </td>
</tr>
</table> 
</div>
<div id="dialog-spreg-result" title="Spatial Regression Result">
  <div id="spreg-result-tabs">
    <ul>
      <li><a href="#tabs-1">Report</a></li>
      <li><a href="#tabs-2">Predicted Values and Residuals</a></li>
    </ul>
    <div id="tabs-1" style="height:100%">
      <pre id="txt-spreg-summary" style="text-align:left; font-size: 12px; white-space:pre-wrap;width: 100%; padding: 10px; border: none; height: 100%; margin: -10px; border: 1px solid #ccc;"> </pre>
    </div>
    <div id="tabs-2" style="height:100%">
      <button id="btn-save-predy">Save values to datasource</button>
      <a href="#" id="btn-export-predy">Export to CSV</a>
      <div id="txt-spreg-predy" > </div>
    </div>
  </div>
</div>
<script>
var prev_obj;
$('#y_catalog h2, #x_catalog h2').click(function(){
  if ( prev_obj ) {
    prev_obj.css("border", "");
  }
  prev_obj = $(this).next();
  prev_obj.css("border", "2px solid red");
});
$('#ul-x-variables').selectable().click( function(evt) {
  console.log($(evt.target).parent(),evt.target, evt.target.innerText); 
  if ( prev_obj == undefined || !$(evt.target).parent().is("li") ) return;
  var txt_var = evt.target.innerText;
  var box = prev_obj.children().first();
  box.find( ".placeholder" ).remove();
  // customized behavior for different dropbox
  var box_id = box.closest("div").attr("id");
  var n_items = box.children().length;
  if ( n_items > 0) {
    if (box_id === 'y_box'||box_id==='r_box') 
      return; 
  }
  // drop gragged item
  $( "<li></li>" ).text(txt_var).appendTo(box).dblclick(function(){
    $(this).remove();
    $(evt.target).parent().show();
  });
  $(evt.target).parent().hide();
});
$('#btn-save-predy').click(function() {
  var count=0, param;
  $('#txt-spreg-predy').children("table").each(function(i,tbl) {
    var content = $(tbl).html().replace(/\<th\>|\<\/th\>|\<tbody\>|\<\/tbody\>|\<tr\>|\<\/tr\>|\<\/td\>/g,"").replace(/\<td\>/g,",");
    if (param == undefined) param = {};
    param["predy" + i] = content;
    count = i;
  });
  var layer_uuid = localStorage['current_layer'];
  if (param && layer_uuid) {
    param["n"] = count+1;
    param["layer_uuid"] = layer_uuid;
    param["csrfmiddlewaretoken"] = "{{csrf_token}}";

  $(this).attr("disabled", "disabled");
  $(html_load_img).insertAfter("#btn-save-predy");

  $.post("../save_spreg_result/", param, function() {
  }).done( function(result) {
    console.log(result);
  }).always( function() {
    //$("#btn-save-predy").removeAttr("disabled");
    $("#btn-save-predy").next().remove();
    $(html_check_img).insertAfter("#btn-save-predy");
  });
}
});
$('#btn-export-predy').on('click', function(event) {
  exportTableToCSV.apply(this, [$('#txt-spreg-predy>table'),'export.csv']);
});
</script>

<div id="dialog-preference" title="Preference">
  <form id="form-pref">{% csrf_token %}
  <div id="tabs">
    <ul>
      <li><a href="#tabs-1">Std Dev</a></li>
      <li><a href="#tabs-2">GMM</a></li>
      <li><a href="#tabs-3">ML</a></li>
      <li><a href="#tabs-4">Instruments</a></li>
      <li><a href="#tabs-5">Output</a></li>
      <li><a href="#tabs-6">Regimes</a></li>
      <li><a href="#tabs-7">Other</a></li>
    </ul>
    <div id="tabs-1">
      <p><b>Compute Standard Deviation with N or N-K</b></p>
      <table>
        <tr><td></td><td width="40">N-K</td><td width="40">N</td></tr>
        <tr><td>OLS</td><td><input type="radio" name="sig2n_k_ols" value=0 checked></td><td><input type="radio" name="sig2n_k_ols" value=1></td></tr>
        <tr><td>2SLS</td><td><input type="radio" name="sig2n_k_2sls" value=0></td><td><input type="radio" name="sig2n_k_2sls" value=1 checked></td></tr>
        <tr><td>GM-Lag</td><td><input type="radio" name="sig2n_k_gmlag" value=0></td><td><input type="radio" name="sig2n_k_gmlag" value=1 checked></td></tr>
        <tr><td>All Other Models</td><td><input type="radio" name="sig2n_k_other" value=0></td><td><input type="radio" name="sig2n_k_other" value=1 checked></td></tr>
      </table>
    </div>
    <div id="tabs-2">
      <table>
        <tr><th>Improved Efficiency</th></tr>
        <tr>
          <td>Maximum Iteration</td>
          <td><input id="spinner" name="gmm_max_iter" value=1></td>
        </tr>
        <tr>
          <td>Stopping Criterion<br>(change in Lambda)</td>
          <td><input id="spinner" name="gmm_epsilon" value="0.00001"></td>
        </tr>
        <tr><th><b>Spatial Error Model</b></th><th></th></tr>
        <tr>
          <td>Inference on Lambda</td>
          <td><input type="checkbox" name="gmm_inferenceOnLambda" checked></td>
        </tr>
        <tr><th><b>Heteroskedasticity</b></th><th></th></tr>
        <tr>
          <td>Computation of Inverse</td>
          <td>
            <select name="gmm_inv_method">
              <option value="Power Expansion" selected>Power Expansion</option>
              <option value="True Inverse">True Inverse</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Step 1c from Arraiz et al (2010)</td>
          <td><input type="checkbox" name="gmm_step1c"></td>
        </tr>
      </table>
    </div>
    <div id="tabs-3">
      <table>
        <tr><th>Diagnostics</th></tr>
        <tr>
          <td>ML Diagnostics</td>
          <td><input type="checkbox" name="ml_diagnostics"></td>
        </tr>
        <tr><th>Methods</th><th></th></tr>
        <tr>
          <td>ML Method</td>
          <td>
            <select name="ml_method">
              <option value="Full">Full</option>
              <option value="Ord">Ord</option>
            </select>
          </td>
        </tr>
        <tr>
          <td>Tolerance Criterion</td>
          <td><input type="text" name="ml_epsilon" value="0.00001"></td>
        </tr>
      </table>
    </div>
    <div id="tabs-4">
      <table>
        <tr>
          <td>Order of Spatial Lags for Instruments</td>
          <td><input id="spinner" name="instruments_w_lags" value="1"></td>
        </tr>
        <tr>
          <td>Include Lags of User-Specified Instruments</td>
          <td><input type="checkbox" name="instruments_lag_q" checked></td>
        </tr>
      </table>
    </div>
    <div id="tabs-5">
      <table>
        <tr>
          <td>Show Variance-Covariance Matrix</td>
          <td><input type="checkbox" name="output_vm_summary"></td>
        </tr>
        <tr>
          <td>Save Predicted Values and Residuals</td>
          <td><input type="checkbox" name="output_save_pred_residuals"></td>
        </tr>
        <tr>
          <td>Save Detailed Model Specification</td>
          <td><input type="checkbox" name="output_show_detailed_spec"></td>
        </tr>
      </table>
    </div>
    <div id="tabs-6">
      <table>
        <tr>
          <td>Error by Regimes</td>
          <td><input type="checkbox" name="regimes_regime_error" checked></td>
        </tr>
        <tr>
          <td>Spatial Lag by Regimes</td>
          <td><input type="checkbox" name="regimes_regime_lag"></td>
        </tr>
      </table>
    </div>
    <div id="tabs-7">
      <table>
        <tr><th>Diagnostics</th></tr>
        <tr>
          <td>OLS Diagnostics</td>
          <td><input type="checkbox" name="other_ols_diagnostics" checked></td>
        </tr>
        <tr>
          <td>White Test (OLS only)</td>
          <td><input type="checkbox" name="white_teste"></td>
        </tr>
        <tr>
          <td>Moran's I of the Residuals</td>
          <td><input type="checkbox" name="other_residualMoran"></td>
        </tr>
        <tr><th><b>Data</b></th><th></th></tr>
        <tr>
          <td>Replace Missing Values With</td>
          <td><input type="text" name="other_missingValue" value=""></td>
        </tr>
      </table>
    </div>
  </div>
  </form>
</div>

<div id="dlg-add-uniqid" title="Add Unique ID">
    <label for="name">Input an unique ID name:</label>
    <input type="text" id="uniqid_name" class="text ui-widget-content ui-corner-all">
</div>

<div id="dlg-save-model" title="Save Spreg Model">
    <label for="name">Input a model name:</label>
    <input type="text" id="model_name" class="text ui-widget-content ui-corner-all">
</div>

<div id="dlg-open-model" title="Open Spreg Model">
    <label for="name">Select a spreg model:</label>
    <select id="open_spreg_model">
    </select>
</div>

<script>
var restSpreg = function() {
  $.each($('#x_box li, #y_box li, #ye_box li, #inst_box li, #r_box li'), function(i, v) { $(v).dblclick();});
  $('input[name="model_type"][value="0"]').prop('checked', true)
  $('input[name="method"]').prop('disabled', true)
  $('input[name="method"][value="0"]').prop('checked', true).prop('disabled', false);
  $('input:checkbox[name=stderror]').each(function(i,obj){
    $(obj).prop('checked', false);
  });
};

$(function() {
  $( "#y_catalog" ).accordion();
  $( "#x_catalog" ).accordion();
  $( "#w_catalog_model" ).accordion();
  $( "#w_catalog_kernel" ).accordion();
  $( "#vars ul li" ).draggable({
    helper: "clone"
  });

  $( ".drop_box ol li" ).dblclick(function() {
  });

  $( ".drop_box ol" ).droppable({
    activeClass: "ui-state-default",
    hoverClass: "ui-state-hover",
    accept: ":not(div)",
    drop: function( event, ui ) {
      $( this ).find( ".placeholder" ).remove();
      // customized behavior for different dropbox
      var box_id = $(this).closest("div").attr("id");
      var n_items = $(this).children().length;
      if ( n_items > 0) {
        if (box_id === 'y_box'||box_id==='r_box') 
          return; 
      }
      // drop gragged item
      $( "<li></li>" ).text( ui.draggable.text() ).appendTo( this ).dblclick(function(){
        $(this).remove();
        ui.draggable.show();
      });
      ui.draggable.hide();
    }
  }).sortable({
    items: "li:not(.placeholder)",
    sort: function() {
      // gets added unintentionally by droppable interacting with sortable
      // using connectWithSortable fixes this, but doesn't allow you to customize active/hoverClass options
      $( this ).removeClass( "ui-state-default" );
    }
  });

  // model type
  $('input:radio[name=model_type]').click( function() {
    var model_type = $(this).val();
    if ( model_type == 0 ) {
      $("input[name='method'], input[name='stderror']").prop('disabled', false);
      $('#ml, #gmm, #het').prop('disabled', true);
      $('#ols').prop('checked', true);
      $("input[name='stderror']").prop('checked', false);
    } else if ( model_type == 1 ) {
      $("input[name='method'], input[name='stderror']").prop('disabled', false);
      $('#ols, #het').prop('disabled', true);
      $('#gmm').prop('checked', true);
      $("input[name='stderror']").prop('checked', false);
    } else if ( model_type == 2 ) {
      $("input[name='method'], input[name='stderror']").prop('disabled', false);
      $('#ols, #white, #hac').prop('disabled', true);
      $('#gmm').prop('checked', true);
      $("input[name='stderror']").prop('checked', false);
    } else if ( model_type == 3 ) {
      $("input[name='method'], input[name='stderror']").prop('disabled', false);
      $('#ols, #ml, #white, #hac').prop('disabled', true);
      $('#gmm').prop('checked', true);
      $("input[name='stderror']").prop('checked', false);
    }
  });
  $('input:radio[name=model_type]:first').click();

  $( "#dialog-preference" ).dialog({
    height: 400,
    width: 580,
    autoOpen: false,
    modal: true,
    dialogClass: "dialogWithDropShadow",
    buttons: {
      "Restore Defaults": function() {
        $( this ).dialog( "close" );
      },
      "Restore System Defaults": function() {
        $( this ).dialog( "close" );
      },
      Cancel: function() {
        $( this ).dialog( "close" );
      },
      "Save": function() {
        console.log($("#form-pref").serialize());
        $.ajax({
        url: "../save_spreg_p/",
          type: "post",
          data: $("#form-pref").serialize(),
          success: function( data ) {}
        });
      },
    }
  });
  $( "#dialog-spreg-result" ).dialog({
    height: 500,
    width: 800,
    autoOpen: false,
    modal: true,
    dialogClass: "dialogWithDropShadow",
    buttons: {
      "Save to pdf": function() {
        //$( this ).dialog( "close" );
        var layer_uuid = localStorage.getItem('current_layer');
        if ( layer_uuid ) {
          var txt = $('#txt-spreg-summary').text();
          txt = txt.replace(/"/g, '');
          txt = txt.replace(/<br>/g, '\n');
          txt = txt.replace(/<\/tr>/g, '\n');
          txt = txt.replace(/<\/td>/g, '    ');
          console.log(txt);
          var inputs = '';
          inputs += '<input type="hidden" name="layer_uuid" value="' + 
              layer_uuid + '" />';
          inputs += '<input type="hidden" name="csrfmiddlewaretoken" value="{{csrf_token}}" />';
          inputs += '<input type="hidden" name="text" value="' + txt + '" />';
          jQuery('<form action="../save_pdf/" method="post">' + 
              inputs + '</form>').appendTo('body').submit().remove();
        }
      },
      Cancel: function() {$( this ).dialog( "close" );},
    }
  });
  
  var options = { valueNames: ['name'] };
  var varList = new List('vars', options);
  
  $( "#dialog-regression" ).dialog({
    dialogClass: "dialogWithDropShadow",
    width: 900,
    height: 800,
    autoOpen: false,
    modal: true,
  });
    
  $( "#dlg-add-uniqid" ).dialog({
    dialogClass: "dialogWithDropShadow",
    width: 400,
    height: 200,
    autoOpen: false,
    modal: true,
    buttons: {
      "Add": function() {
        var that = $(this);
        var layer_uuid = localStorage.getItem('current_layer');
        if ( layer_uuid ) {
          var name = $('#uniqid_name').val(),
              conti = true;
          $.each($('#sel-w-id').children(), function(i,j) { 
            if( name == $(j).text()) {
              ShowMsgBox("","Input unique ID field already exists.");
              conti = false;
              return;
            }
          })
          if ( conti == true ) {
            params = { 'layer_uuid': layer_uuid, 'name': name, csrfmiddlewaretoken: '{{ csrf_token }}'};
            $.post("../add_UID/", params, function() {
            }).done(function(data) { 
              console.log("add_uid", data); 
              if (data["success"] == 1) {
                loadFieldNames(function(){
                  $('#sel-w-id').val(name).change()
                });
                that.dialog( "close" );
                ShowMsgBox("", "Add uniue ID successful.");
                ;
              }
            });
          }
        }
      },
      Cancel: function() {$( this ).dialog( "close" );},
    }
  });
  $( "#dlg-save-model" ).dialog({
    dialogClass: "dialogWithDropShadow",
    width: 400,
    height: 200,
    autoOpen: false,
    modal: true,
    buttons: {
      "Save": function() {
        var layer_uuid = localStorage.getItem('current_layer');
        if ( layer_uuid ) {
          var w_list = $.GetValsFromObjs($('#sel-model-w-files :selected'));
          var wk_list = $.GetValsFromObjs($('#sel-kernel-w-files :selected'));
          var model_type = $('input:radio[name=model_type]:checked').val();
          var method = $('input:radio[name=method]:checked').val();
          var name = $('#model_name').val();
          var x = $.GetTextsFromObjs($('#x_box li'));
          var y = $.GetTextsFromObjs($('#y_box li'));
          var ye = $.GetTextsFromObjs($('#ye_box li'));
          var h = $.GetTextsFromObjs($('#inst_box li'));
          var r = $.GetTextsFromObjs($('#r_box li'));
          //var t = $.GetTextsFromObjs($('#t_box li'));
          var t = [];
          var error = [0,0,0];
          $('input:checkbox[name=stderror]').each(function(i,obj){
            if (obj.checked) error[i] = 1;
          });
          params = { 'layer_uuid': layer_uuid, 'name': name, 'w': w_list, 'wk': wk_list, 'type': model_type, 'method': method, 'error': error, 'x': x, 'y': y, 'ye': ye, "h": h, "r": r, "t": t, csrfmiddlewaretoken: '{{ csrf_token }}'};
          console.log(params);
          $.post("../save_spreg_model/", params, function() {
          }).done(function(data) { 
            console.log(data); 
            loadModelNames();
            ShowMsgBox("","Save model done.");
          });
        }
        $(this).dialog("close");
      },
      Cancel: function() {$( this ).dialog( "close" );},
    }
  });
    
  $( "#dlg-open-model" ).dialog({
    dialogClass: "dialogWithDropShadow",
    width: 400,
    height: 200,
    autoOpen: false,
    modal: true,
    buttons: {
      "Open": function() {
        var layer_uuid = localStorage.getItem('current_layer');
        if ( layer_uuid ) {
          var model_name = $('#open_spreg_model').val();
          if (model_name ) {
            $.get("../load_spreg_model/", {'layer_uuid':layer_uuid,'name':model_name}, function(){})
            .done(function(data) {
              console.log(data);
              if ( data["success"] != 1 ) {
                console.log("load spreg model failed.");
              } else {
                resetSpreg();
                $('input[name="model_type"][value='+data['type']+']').prop('checked', true);
                $('input[name="method"][value='+data['method']+']').prop('checked', true);
                var error = data['stderror'];
                $('input:checkbox[name=stderror]').each(function(i,obj){
                  if (error[i] == 1) $(obj).prop('checked', true);
                });
                $.each( data['w'], function(i, w) {$('#sel-model-w-files').val(w);});
                $.each( data['kw'], function(i, w) {$('#sel-kernel-w-files').val(w);});
                var load_vars = function( vars, box ) {
                  $.each( vars, function(i, v) {
                    if ( v && v.length > 0 ) {
                      if (i == 0) box.find( ".placeholder" ).remove();
                      var item = $('#ul-x-variables p').filter(function(i, p){ 
                        return $(p).text() == v;
                      }).parent().hide();
                      var ctn = box.closest("div").children().first();
                      $( "<li></li>" ).text(v).appendTo(ctn).dblclick(function(){
                        $(this).remove();
                        item.show();
                      });
                    }
                  });
                };
                load_vars( data['y'], $('#y_box') );
                load_vars( data['x'], $('#x_box') );
                load_vars( data['ye'], $('#ye_box') );
                load_vars( data['h'], $('#inst_box') );
                load_vars( data['r'], $('#r_box') );
                //load_vars( data['t'], $('#t_box') );
              } 
            });
          }
        }
        $(this).dialog("close");
      },
      Cancel: function() {$( this ).dialog( "close" );},
    },
  });
    
  $( "#tabs" ).tabs();
  $( "#spreg-result-tabs" ).tabs();
  
  $( "#btn_open_model" ).button({icons: {primary: "ui-icon-folder-open"}})
  .click(function() {
    $('#dlg-open-model').dialog('open');
  });
  $( "#btn_save_model" ).button({icons: {primary: "ui-icon-disk"}})
  .click(function() {
    $('#dlg-save-model').dialog('open');
  });
  
  $( "#btn_reset_model" ).button({icons: {primary: "ui-icon-)circle-close"}})
  .click(function() { restSpreg(); });
  
  $( "#btn_preference" ).button({icons:{primary: "ui-icon-gear",}})
  .click(function(){ $('#dialog-preference').dialog('open');});
  
  $( "#btn_result" ).button({icons: {primary: "ui-icon-document",}})
  .click(function(){
    $('#dialog-spreg-result').dialog('open').draggable('disable');
  }).hide();
    
  $( "#btn_create_w" ).button({icons: {primary: "ui-icon-plus",}})
  .click(function(){
    $('#dialog-weights').dialog('open');
  });
    
  $( "#btn_run" ).button({icons: {primary: "ui-icon-circle-triangle-e",}})
  .click(function() {
    var layer_uuid = localStorage.getItem('current_layer');
    if (  layer_uuid == undefined ) {
      console.log("Error: layer_uuid is not defined.");
      return;
    }
    var w_list = $.GetValsFromObjs($('#sel-model-w-files :selected'));
    var wk_list = $.GetValsFromObjs($('#sel-kernel-w-files :selected'));
    var model_type = $('input:radio[name=model_type]:checked').val();
    var method = $('input:radio[name=method]:checked').val();
    // y, x, w, 
    var x = $.GetTextsFromObjs($('#x_box li'));
    var y = $.GetTextsFromObjs($('#y_box li'))[0];
    var ye = $.GetTextsFromObjs($('#ye_box li'));
    var h = $.GetTextsFromObjs($('#inst_box li'));
    var r = $.GetTextsFromObjs($('#r_box li'));
    //var t = $.GetTextsFromObjs($('#t_box li'));
    var t = [];
    // check error flag 
    var error = [0,0,0];
    var conti = true;
    $('input:checkbox[name=stderror]').each(function(i,obj){
      if (obj.checked){ 
      error[i] = 1;
        if ( i==1 && w_list.length == 0 ) {
          ShowMsgBox("","Please select weights file for model.");
          conti = false;
          return;
        }
        if ( i==1 && wk_list.length == 0 ) {
          ShowMsgBox("","Please select kernel weights file for model.");
          conti = false;
          return;
        }
      }
    });
    if ( conti == false) return;
    // run model
    $('#dlg-run').dialog("open").html('<img src="{{url_prefix}}/media/img/loading.gif"/><br/>Loading ...');
    $('#dlg-run').siblings('.ui-dialog-titlebar').hide();
    params = {
      'layer_uuid': layer_uuid, 'w': w_list, 'wk': wk_list, 
      'type': model_type, 'method': method, 'error': error, 'x': x, 'y': y, 
      'ye': ye, "h": h, "r": r, "t": t, 
      csrfmiddlewaretoken: '{{ csrf_token }}'
    };
    $.post("../spatial_regression/", params, function() {
      $('#btn_result').hide();
    }).done(function(data) {
      $('#dlg-run').dialog("close");
      try {
        data = JSON.parse(data);
        if ( data['success'] == 1 ) {
          $('#btn_result').show();
          if ( data['report'] ) {
            var predy = "", summary = "", cnt= 0;
            $.each(data['report'], function(id, result) { 
              cnt+=1;
            });
            cnt = cnt.toString();
            $.each(data['report'], function(id, result) {
              var idx = parseInt(id) + 1
              summary += "Report " + idx + "/" + cnt + 
                "\n\n"+result['summary'] + "\n\n";
              predy += "<b>Report " + idx + "/" + cnt +"</b><br/><br/>";
              predy += "<table border=1 width=100% id='predy" + id + 
                "'><tr><th>Predicted Values</th><th>Residuals</th></tr>";
              var n = result['predy'][0].length;
              for ( var i=0; i< n; i++ ) {
                predy += "<tr><td>" + result['predy'][0][i] + "</td><td>" + 
                  result['residuals'][0][i] + "</td></tr>";
              }
              predy += "</table><br/><br/>";
            });
            $('#txt-spreg-predy').html(predy);
            $('#txt-spreg-summary').text(summary);
          }
          $('#btn_result').popupDiv('#divPop','Click this button to see result.');
        }
      } catch (e) {console.log(e);}
    })
    .fail(function(data){ 
      $('#dlg-run').dialog("close");
      ShowMsgBox("Erro","Spatial regression failed.");
    });
    });
  });
</script>

<div id="dialog-weights"  title="Weights Creation Dialog">
  <style>
  .ui-widget-overlay { background: #aaa repeat-x; opacity: .8;}
  table { border-spacing: 0;}
  th { text-align: left; padding: 10px 0 10px 0; }
  td { text-align: left;}
  .custom-combobox { position: relative; display: inline-block;}
  .custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
    /* support: IE7 */
    *height: 1.7em;
    *top: 0.1em;
  }
  .custom-combobox-input {
    margin: 0;
    padding: 0.3em;
  }
  .dlg-loading {
    background: white url('{{url_prefix}}/media/img/loading_small.gif') center center no-repeat;
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
  }
  </style>
  <table>
    <tr>
      <td><li>Please input a Weights name</li></td>
      <td><input type="text" id="txt-w-name"></td>
    </tr>
    <tr>
      <td><li>Select an ID variable for weights file:</li></td>
      <td valign="center">
      <select id='sel-w-id'></select>
      <img id="img-id-chk" src="{{url_prefix}}/media/img/checkmark.png">
      <img id="img-id-nochk" src="{{url_prefix}}/media/img/uncheckmark.gif">
      <img id="img-id-spin" src="{{url_prefix}}/media/img/loading_small.gif">
      </td>
    </tr>
  </table>
  <br/>
  <br/>
  <div id="tabs-dlg-weights">
    <ul>
      <li><a href="#tabs-1">Contiguity</a></li>
      <li><a href="#tabs-2">Distance</a></li>
      <li><a href="#tabs-3">Adaptive Kernel</a></li>
    </ul>
    <div id="tabs-1">
      <form id="cont-form">
        <table>
          <tr>
            <td>Contiguity Type</td>
            <td>
              <select id="sel-cont-type">
                <option value="0" selected>Rook</option>
                <option value="1">Queen</option>
              </select>
            </td>
          </tr>
          <tr>
            <td>Order of Contiguity</td>
            <td><input id="spn-cont-order" value=1></td>
          </tr>
          <tr>
            <td>Include Lower Orders</td>
            <td><input type="checkbox" id="cbx-cont-ilo"></td>
          </tr>
        </table>
      </form>
    </div>
    <div id="tabs-2">
      <table>
        <tr>
          <td>Select Distance Metric</td>
          <td>
            <select id="sel-dist-metr">
              <option value="0" selected>Euclidean Distance</option>
              <option value="1">Arc Distance (miles)</option>
              <option value="2">Arc Distance (kilometers)</option>
            </select>
          </td>
        </tr>
        <tr height="22px">
          <td><input type="radio" name="rdo-dist" id=0> k-Nearest Neighbors</td>
          <td># of neighbors <input id="spn-dist-knn" value="1"></td>
        </tr>
        <tr>
          <td><input type="radio" name="rdo-dist" id=1>Binary Distane Band</td>
          <td>
            <input type="text" id="txt-dist-thr" value="0.0" style="float:left;margin-right:100px;width:100px">
            <div id="dist-slider" style="margin: 5px 0 0 120px;"></div>
          </td>
        </tr>
        <tr>
          <td><input type="radio" name="rdo-dist" id=2>Power of Inverse Distance</td>
          <td><input id="spn-pow-idst" value="1"></td>
        </tr>
      </table>
    </div>
    <div id="tabs-3">
      <table>
        <tr>
          <td>Select Kernel Function Type</td>
          <td>
              <select id="sel-kel-type">
              <option value="0" selected>Uniform</option>
              <option value="1">Triangular</option>
              <option value="2">Quadratic</option>
              <option value="3">Quartic</option>
              <option value="4">Gaussian</option>
              </select>
          </td>
        </tr>
        <tr>
          <td>Number of Neighbors</td>
          <td><input type="text" id="txt-kel-nn" value="1"></td>
        </tr>
      </table>
    </div>
  </div>
  <br/><br/><br/>
  <table>
    <tr>
      <td><li>Select to download a Weights file</li></td>
      <td><select id='sel-w-type'>
          <option value="gal" selected>GAL</option>
          <option value="gwt">GWT</option>
          <option value="kwt">KWT</option>
        </select>
      </td>
      <td><select id='sel-w-files'></select></td>
    </tr>
  </table>
  <div class="dlg-loading"></div>
</div> 
<script>
// weights creation javascript code
$('#sel-w-files').change( function() {
  var layer_uuid = localStorage['current_layer'];
  var w_name = $('#sel-w-files').val();
  if ( w_name && layer_uuid ) {
    var w_type = $('#sel-w-type').val();
    $.download(
      "../download_w/",
      "layer_uuid=" + layer_uuid + "&w_name=" + w_name + "&w_type=" + w_type,
      "get"
    ); 
  }
  $(this).prop("selectedIndex", -1);
});
$('.dlg-loading').hide();
$('#dist-slider').slider({
  min: 0,
  max: 100,
  slide: function( event, ui ) { $('#txt-dist-thr').val(ui.value); }
});

$('#spn-pow-idst, #spn-cont-order, #spn-dist-knn').spinner();
$('#tabs-dlg-weights').tabs();
  
var timeoutRef;
function checkWname() {
  if (!timeoutRef) {
    return;
  }
  timeoutRef = null;
  var layer_uuid = localStorage['current_layer'],
      w_name = $("#txt-w-name").val();
  $('#txt-w-name').next().remove();
  if ( layer_uuid && w_name ) { 
    $(html_load_img).insertAfter("#txt-w-name");
    $.get('../check_w/', { 'w_name': w_name, 'layer_uuid':layer_uuid,}, function(){
      $('#txt-w-name').next().remove();
    }).done( function( data ) {
      $('#txt-w-name').next().remove();
      if ( data == "1" ) {
        $('<font color=red>duplicated name</span>').insertAfter($("#txt-w-name"));
      } else {
        $(html_check_img).insertAfter("#txt-w-name");
      }
    }).always( function() {});
  }
}
$('#txt-w-name').keypress(function() {
  var el = this;
  if ( timeoutRef ) clearTimeout(timeoutRef);
  timeoutRef = setTimeout(function() {checkWname.call(el);}, 1000);
  $('#txt-w-name').blur(function(){ checkWname.call(el); });
});
  
$('#sel-w-id').prop("selectedIndex", -1);
$('#sel-w-id').change(function() {
  var layer_uuid = localStorage['current_layer'];
  var id_name = $('#sel-w-id').val();
  $("#img-id-chk, #img-id-nochk, #img-id-spin").hide();          
  if ( id_name == "" ) {
    return;
  } else if ( id_name == "0" ) {
    $('#dlg-add-uniqid').dialog('open');
    return;
  } else if ( id_name && layer_uuid ) {
    $("#img-id-spin").show();          
    $.get('../check_ID/',{'layer_uuid':layer_uuid, 'id_name':id_name},function(){ 
      $("#img-id-spin").show(); })
    .done(function(data) {
      if ( data == "1" ) {
        $("#img-id-chk").show();          
        $("#img-id-nochk, #img-id-spin").hide();          
      } else {
        $("#img-id-nochk").show();          
        $("#img-id-chk, #img-id-spin").hide();          
      }
    });
  }
});
$( "#dialog-weights" ).dialog({
  height: 380,
  width: 480,
  autoOpen: false,
  modal: true,
  dialogClass: "dialogWithDropShadow",
  buttons: {
    "Create": {
      text: "Create",
      id: "btn-create-w",
      click: function() {
        var layer_uuid = localStorage['current_layer'];
        if ( layer_uuid == undefined ) return;
        var w_name = $('#txt-w-name').val(),
        w_id = $('#sel-w-id').find(":selected").val(),
        active = $('#tabs-dlg-weights').tabs("option","active");
        if ( w_name.length == 0 ) {
          ShowMsgBox("Error", "Weights name can't be empty.");
          return;
        }
        if ( w_id.length == 0 || $('#img-id-nochk').is(":visible") ) {
          ShowMsgBox("Error", "An unique ID for weights creation is required.");
          return;
        }
        var post_param = {
          'layer_uuid': layer_uuid,
          'w_id': w_id, 'w_name': w_name, 
          csrfmiddlewaretoken: '{{ csrf_token }}',
        };
          
        if ( active == 0 ) {
          var cont_type = $('#sel-cont-type').find(":selected").val(),
              cont_order = $('#spn-cont-order').val(),
              cont_ilo = $('#cbx-cont-ilo').prop("checked");
              post_param['cont_type'] = cont_type;
              post_param['cont_order'] = cont_order;
              post_param['cont_ilo'] = cont_ilo;
  
        } else if ( active == 1) {
          var dist_value = "",
              dist_metric = $('#sel-dist-metr').val(),
              dist_method =$('input:radio[name=rdo-dist]:checked').attr("id");
    
          if ( dist_method == 0 ) {
            dist_value = $('#spn-dist-knn').val();
          } else if ( dist_method == 1 ) {
            dist_value = $('#txt-dist-thr').val();
          } else if ( dist_method == 2 ) {
            dist_value = $('#txt-dist-thr').val() + "," + $('#spn-pow-idst').val();
          } else {
            ShowMsgBox("","Please select a distance method.");
            return;
          }
  
          post_param['dist_metric'] = dist_metric;
          post_param['dist_method'] = dist_method;
          post_param['dist_value'] = dist_value;

        } else if ( active == 2) {
          post_param['kernel_type'] = $("#sel-kel-type").val(); 
          post_param['kernel_nn'] = $("#txt-kel-nn").val();
        }
  
        // submit request
        $("#btn-create-w").attr("disabled",true).fadeTo(0, 0.5);
        $(html_load_img).insertBefore("#btn-create-w");
        post_param['w_type'] = active;
        $.post("../create_weights/", post_param, function(){})
          .done(function( data ) {
            console.log("create_weights", data);
            if ( data["success"] == 1 ) {
              $('#txt-w-name').val("").next().remove();
              $('#sel-w-id').next().remove();
              loadWnames();
              $('#sel-w-id').prop("selectedIndex", -1);
              ShowMsgBox("","Create weights done.");
              return;
            }
            ShowMsgBox("Error", "Create weights failed.");
          })
          .fail(function() { ShowMsgBox("Error", "Create weights failed."); })
          .always(function(){
            $("#btn-create-w").attr("disabled",false)
              .fadeTo(0, 1)
              .prev().remove();
          });
        }
      },
      "Close": function() {
      $( this ).dialog( "close" );
    },
  }
});
</script>

<div id="dlg-msg" title="Message">
  <div class="text-align:left;">
    <p class="font-weight:bold;" id="msg-title"></p>
    <p id="msg-content" class="text-align:left;"></p>
  </div>
</div>

<style>
#dlg-run { background: url({{url_prefix}}/media/img/loading_small.gif) no-repeat 5px 8px);
padding-left: 25px;
</style>
<div id="dlg-run">
</div>
</body>
</html>
