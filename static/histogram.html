<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<style>
html, body {
  font: 11px sans-serif;
  width: 100%;
  height: 100%;
  margin: 0;
}
#container {
  position: relative;
  width: 100%;
  height: 100%;
}
#graph {
  position: absolute;
  top: 0;
  left: 0;
}
svg {
  position: relative;
  width: 100%;
  height: 100%;
}
.bar rect {
  fill: steelblue;
  shape-rendering: crispEdges;
}
.hover {
  border: 1px solid yellow;
  -webkit-filter: drop-shadow(10px 10px 10px #222);
  filter:         drop-shadow(10px 10px 10px #222); 
}
.bar text {
  fill: #000;
}

.axis path, .axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

</style>
<script src="../media/js/require.js" charset="utf-8"></script>
</head>
<body>
<div id="container"> 
  <canvas></canvas>
  <svg id='graph'></svg>
</div>
<script>


require.config({
    baseUrl: '../media/js',
    paths: {
        jquery: './lib/jquery.min',
        d3: './lib/d3.v3.min',
        colorbrewer  : './lib/colorbrewer',
    },
    shim : {
      d3 : {exports : 'd3'},
      colorbrewer: {exports : "colorbrewer"},
    }
});

// test only
//var uuid = "abcd1234";

require(["./ui/cartoProxy","./ui/utils", 'colorbrewer', 'd3'],
function(CartoProxy,Utils, colorbrewer, d3){

  console.log(this.window, CartoProxy, colorbrewer, d3);
  
  var x, y, data, xAxis, yAxis, results, numbins, barWidth;
  var resizeTimer;
  
  var colors = colorbrewer.Paired[10];
  
  var table_name = Utils.getParameterByName('table_name'),
      carto_uid = Utils.getParameterByName('carto_uid'),
      carto_key = Utils.getParameterByName('carto_key'),
      var_x = Utils.getParameterByName('x');
      
  var points = [];
      
  var margin = {top: 15, right: 30, bottom: 30, left: 50},
      screenW = parseInt(d3.select("#container").style("width")),
      screenH = parseInt(d3.select("#container").style("height")),
      width = screenW - margin.left - margin.right,
      height = screenH - margin.top - margin.bottom;
      
  var xMin, xMax, xExt;
  
  var brushX = d3.scale.identity().domain([0, width]),
      brushY = d3.scale.identity().domain([0, height]);
  
  var graph = d3.select("#graph")
      .attr("width", screenW)
      .attr("height", screenH)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
  var bin_dict = {}; // bin: [ids]
  
 
  function Highligh(selected_ids) {
  }

  // brush&link-- incoming
  $(this.window).bind('storage', function(e) {
    var key = table_name;
    var hl_ids = JSON.parse(localStorage.getItem('HL_IDS'));
    if ( hl_ids && key in hl_ids ) {
      var ids = hl_ids[key];
      Highlight(ids);
    }
  });
  
  // brush^link -- outgoing
  function OnBinSelect(selected_ids) {
    var key = table_name;
    var hl = {};
    if ( localStorage["HL_IDS"] ){ 
      hl = JSON.parse(localStorage["HL_IDS"]);
    }
    hl[key] = selected_ids;
    localStorage["HL_IDS"] = JSON.stringify(hl);
  } 

  var ProcessData = function(var_x, _data) {  
    var results = _data[var_x],
        n_data = results.length;
    
    for (var i=0; i < n_data; i++ ) {
      var _x = results[i];
      if ( i == 0 ) {
        xMin = _x;
        xMax = _x;
      } else {
        if ( _x < xMin) xMin = _x;
        if ( _x > xMax) xMax = _x;
      }
    }
  
    x = d3.scale.linear()
      .domain([xMin, xMax])
      .range([0, width]).nice();
  
    // Generate a histogram using twenty uniformly-spaced bins.
    data = d3.layout.histogram()
      .bins(x.ticks(10))
      (results);
      
    var bin_thres = x.ticks(10);
    
    for (var b_idx=0, n=bin_thres.length; b_idx < n-1; b_idx++) {
      bin_dict[b_idx]  = [];
      var lbound = bin_thres[b_idx],
          ubound = bin_thres[b_idx+1];
      for (var j=0; j < n_data; j++ ) {
        if (results[j] >= lbound && results[j] < ubound) {
          bin_dict[b_idx].push(j);
        }
      }
    }
    
    numbins = data.length;
    barWidth = (width-10)/numbins - 1;
  
    y = d3.scale.linear()
      .domain([0, d3.max(data, function(d) { return d.y; })])
      .range([height, 0]).nice();
      
    xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
  
    yAxis = d3.svg.axis()
        .scale(y)
        .orient("left");
        
    var bar = graph.selectAll(".bar")
        .data(data)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });
  
    console.log(x(data[0].dx));
    console.log(x(data[1].dx));
    
    bar.append("rect")
        .attr("x", 1)
        .attr("id", function(d,i) { return i;})
        .attr("width", barWidth)
        .attr("height", function(d) { return height +2 - y(d.y) ; })
        .style('fill', function(d,i) {return colors[i%10];})
        .on("click",function(){ 
            var bin_idx = $(this).attr("id")
                selected_ids = bin_dict[bin_idx];
              
            if (selected_ids) {
              // highlight/linking
              OnBinSelect(selected_ids);
            }
          })
        .on("mouseover",function(){
            $(this).attr("fill-old", $(this).css("fill"));
            $(this).css("fill", 'rgb(255,255,0)');
            $(this).css("cursor", "hand");
          })
        .on("mouseout",function(){
            if($(this).attr("fill-old")) 
              $(this).css("fill", $(this).attr("fill-old"));
          });
  
    bar.append("text")
        .attr("y", 0) 
        .attr("x", x(data[0].dx) / 2)
        .attr("text-anchor", "middle")
        .text(function(d) { return d.y; });
  
    graph.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (parseInt(height) + 10) +  ")")
        .call(xAxis);
        
    graph.append("g")
        .attr("class", "y axis")
        .call(yAxis)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 6)
        .attr("dy", ".71em");

  };
 
  function resize() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(OnResizeDone, 500);
  }
  var OnResizeDone = function(evt) {
  
    screenW = parseInt(d3.select("#graph").style("width"));
    screenH = parseInt(d3.select("#graph").style("height"));
    
    width = screenW - margin.left - margin.right;
    height = screenH - margin.top- margin.bottom;
    
    x.range([0, width]);
      
    barWidth = width/numbins - 1;
      
    y.range([height, 0]);
      
        
    graph.select('.x.axis')
      .attr("transform", "translate(0," + (height+10) + ")")
      .call(xAxis);
  
    graph.select('.y.axis')
        .call(yAxis);
        
    graph.selectAll('.bar')
        .data(data)
        .attr("transform", function(d) { return "translate(" + x(d.x) + "," + y(d.y) + ")"; });
  
    graph.selectAll('rect')    
        .attr("width", barWidth)
        .attr("height", function(d) { return height +2 - y(d.y) ; });
      
    graph.selectAll('text')
        .attr("x", x(data[0].dx) / 2);
    
  };
  
  d3.select(window).on('resize', resize); 
  
  
  // test only
  //data = {'x':[0.0, 0.0, 0.3333333333, 0.6666666667, 0.0, 0.0, 1.0, 0.3333333333, 1.3333333333, 0.0, 0.0, 0.6666666667, 0.0, 0.0, 0.0, 0.0, 0.3333333333, 0.0, 0.0, 0.0]};
  //ProcessData('x', data);
  
  if (table_name)  {
    CartoProxy.SetUID(carto_uid);
    CartoProxy.SetKey(carto_key);
    var isCSV = false;
    
    CartoProxy.GetVariables(table_name, [var_x], isCSV, function(_data){
      ProcessData(var_x, _data);
    });
  }
});

</script>
</body>
</html>
