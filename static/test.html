<!DOCTYPE html>
<html>
<head>
  <title>GeoDa-Web Publication</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  
  <link rel="stylesheet" href="../media/css/cartodb.css" />
  <link rel="stylesheet" href="../media/asserts/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../media/css/custom-theme/jquery-ui-1.10.0.custom.css">
  <link rel="stylesheet" href="../media/asserts/css/font-awesome.min.css" />
  <link rel="stylesheet" href="../media/css/publish.css" />
  
  <script src="../media/js/cartodb.js"></script>
  <script src="../media/js/require.js"></script>
  <script src="../../media/js/zip/zip.js"></script>
</head>
<body>

  <div class="awesome-bar">
      <div class="logo"></div>
  </div>
  
  <div role="main" class="ui-content" id="map-container">
    <div id="map"></div>
  </div>
  
  <canvas class="hl-canvas"></canvas>
  
</body>

<script>
require.config({
    baseUrl: '../media/js',
    paths: {
      jquery: 'lib/jquery.min',
      jqueryui : 'lib/jquery-ui-1.10.4.custom.min',
      d3: 'lib/d3.v3.min',
      colorbrewer  : 'lib/colorbrewer',
    },
    shim : {
      "jqueryui" : {deps: ['jquery']},
      d3 : {exports : 'd3'},
      colorbrewer: {exports : "colorbrewer"},
    }
});

require(["jquery", 
         "./ui/cartoProxy",
         "./ui/utils", 
         "./ui/basemap", 
         "./ui/mapManager", 
         'colorbrewer', 'd3', 'jqueryui'],
function($, CartoProxy,Utils, Basemap, MapManager, colorbrewer, d3) {

  console.log("After libs loaded...");
  var user_id = Utils.getParameterByName('uid');
  var viz_name = Utils.getParameterByName('vizname');
  var plots = Utils.getParameterByName('plots');
  var vizjson_url = '../media/temp/' + user_id + '/' + viz_name + '.json'; // <-- Paste viz.json URL between quotes

  cartodb.createVis("map", vizjson_url) // <-- Change map_id to 'map'
    .done(function(vis, layers) {
      console.log("Map successfully created");
    })
    .error(function(err) {
      console.log("An error occurred: " + err);
    });
    
  // download geometries from CartoDB for interactive 
  //var mapManager = MapManager.getInstance();     
  //Utils.popFrame('boxplot.html');
  

  var uid = "lixun910";
  var key = "340808e9a453af9680684a65990eb4eb706e9b56";
  CartoProxy.SetUID(uid);
  CartoProxy.SetKey(key);  
  
  var table_name = "nat";
  
  CartoProxy.DownloadTable(table_name, function(data) {
    require(['ui/mapManager'], function(MapManager) {
    
      $('.cartodb-map-wrapper').hide()
      
      MapManager.getInstance().AddMap(data, function(map) { });
    });
  });
 
  // Cluster map
  // Moran's I scatter plot
  function PopMoranIScatterPlot(table_name, var_name) {
  }
  
  
  // Plots
  // histogram 
  function PopHistogram(table_name, var_name) {
    var_name = "fh80";
    var url = 'histogram.html?';
    url += 'table_name=' + table_name;
    url += '&carto_uid=' + CartoProxy.GetUID();
    url += '&carto_key=' + CartoProxy.GetKey() + '&';
    url += '&x=' + var_name;
            
    Utils.popFrame(url);
  }
  
  // scatterplot 
  function PopScatterPlot(table_name, var_name_x, var_name_y) {
    var x = "fh80", y = "po80";
    
    var url = 'scatterplot.html?';
    url += 'table_name=' + table_name;
    url += '&carto_uid=' + CartoProxy.GetUID();
    url += '&carto_key=' + CartoProxy.GetKey() + '&';
    url += '&x=' + x + '&y=' + y;
            
    Utils.popFrame(url);
  }
  
  // scatter matrix
  function PopScatterMatrix(table_name, var_names/*[list]*/) {
  }
  
  // parallel coordinates
  function PopParallelCoordinates(table_name, var_names/*[list]*/) {
  }
 
  // box plot
  function PopBoxPlot(table_name, var_name) {
  }
  
  PopHistogram();
  PopScatterPlot();
  
}); // end require

</script>
</html>
